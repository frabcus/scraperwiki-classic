#!/bin/sh
# code-backup
# David Jones, ScraperWiki Limited.
# Backup the code (for our users' scrapers).  Usually run from cron.

# Early bail.
set -e

cd /var/www/scraperwiki/
. bin/activate
dir=$(mktemp -d)
for s in $(ls splitscrapers/)
do
    hg clone splitscrapers/"$s" "$dir/$s" 2>&1 >/dev/null 
done
tar cfP - "$dir" | gzip --rsyncable > /tmp/new-mercurial.tar.gz
mv /tmp/new-mercurial.tar.gz /root/backup/mercurial.tar.gz
rm -rf "$dir"
