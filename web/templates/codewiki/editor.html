<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
<head>
    <title>{{ scraper.title }} | ScraperWiki</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}css/jquery-ui-1.7.2.custom.css" />
    <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}css/main.css?{{settings.REVISION}}" />
    <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}css/editor.css?{{settings.REVISION}}" />
    
    {# See http://orbited.org/wiki/Deployment#Cross-SubdomainDeployment for explanation #}
    <script>document.domain = document.domain;</script>

    <script src="http://{{ settings.ORBETED_DOMAIN }}:{{ settings.ORBETED_PORT }}/static/Orbited.js"></script>
    <script>Orbited.settings.streaming = false</script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery-1.3.2.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery-ui-1.7.2.custom.min.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery.hotkeys.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery.cookie.js"></script>    
    <script type="text/javascript" src="{{ MEDIA_URL }}js/json-min.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery.htmlClean-min.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery.json-2.2.min.js"></script>
	<script type="text/javascript" src="{{ MEDIA_URL }}js/jquery.simplemodal.1.4.js"></script>    
    <script type="text/javascript" src="{{ MEDIA_URL }}CodeMirror-{{codemirrorversion}}/js/codemirror.js"></script>

    {# for the popup preview of cached HTML #}
    <script src="{{ MEDIA_URL }}CodeMirror-{{codemirrorversion}}/js/highlight.js" type="text/javascript"></script> 
    <script src="{{ MEDIA_URL }}CodeMirror-{{codemirrorversion}}/js/stringstream.js" type="text/javascript"></script> 
    <script src="{{ MEDIA_URL }}CodeMirror-{{codemirrorversion}}/js/tokenize.js" type="text/javascript"></script> 
    <script src="{{ MEDIA_URL }}CodeMirror-{{codemirrorversion}}/js/parsexml.js" type="text/javascript"></script> 
    <script src="{{ MEDIA_URL }}CodeMirror-{{codemirrorversion}}/js/parsecss.js" type="text/javascript"></script> 
    <script src="{{ MEDIA_URL }}CodeMirror-{{codemirrorversion}}/js/tokenizejavascript.js" type="text/javascript"></script> 
    <script src="{{ MEDIA_URL }}CodeMirror-{{codemirrorversion}}/js/parsejavascript.js" type="text/javascript"></script> 
    <script src="{{ MEDIA_URL }}CodeMirror-{{codemirrorversion}}/js/parsehtmlmixed.js" type="text/javascript"></script> 
    <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}CodeMirror-{{codemirrorversion}}/css/xmlcolors.css"/> 
    <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}CodeMirror-{{codemirrorversion}}/css/jscolors.css"/> 
    <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}CodeMirror-{{codemirrorversion}}/css/csscolors.css"/> 

    {# the primary library #}
    <script type="text/javascript" src="{{ MEDIA_URL }}js/editor.js?{{settings.REVISION}}"></script>

    {% if not debug %}
        <script type="text/javascript">

          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-21451224-1']);
          _gaq.push(['_trackPageview']);

          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();

        </script>
    {% endif %}
</head>

<body>
    {# Hidden inputs for passing to js #}
    <input type="hidden" id="short_name"        value="{{ scraper.short_name }}"/>
    <input type="hidden" id="scraper_guid"      value="{{ scraper.guid }}"/>
    <input type="hidden" id="sourcescraper"     value="{{ source_scraper }}"/>            
    <input type="hidden" id="fork"              value="{{ fork }}"/>            
    <input type="hidden" id="username"          value="{{ request.user.username }}"/>
    <input type="hidden" id="userrealname"      value="{{ request.user.get_profile.name }}"/>
    <input type="hidden" id="isstaff"           value="{% if request.user.is_staff %}yes{% endif %}"/>
    <input type="hidden" id="scraperlanguage"   value="{{ scraper.language|lower }}"/>
    <input type="hidden" id="originalrev"       value="{{rev}}"/>
    <input type="hidden" id="codemirror_url"    value="{{MEDIA_URL}}CodeMirror-{{codemirrorversion}}/"/>
    <input type="hidden" id="id_wiki_type"      value="{{scraper.wiki_type}}"/>

    {# declare all the URLs the javascript is going to want access to #}
    <input type="hidden" id="userprofileurl"    value="{% url profiles_profile_detail 'XXX' %}"/>
    <input type="hidden" id="saveurl"           value="{% url handle_editor_save %}"/>
    <input type="hidden" id="proxycachedurl"    value="{% url proxycached %}"/>
    <input type="hidden" id="quickhelpurl"      value="{% url quickhelp %}"/>
    {% if scraper.short_name %}
        <input type="hidden" id="viewrunurl"    value="{% url rpcexecute scraper.short_name %}"/>
        <input type="hidden" id="editorreloadurl" value="{% url reload scraper.short_name %}"/>
    {% endif %}

        <div class="editor">
            <div id="divDraftSavedWarning" class="draft_warning" style="display:none;">
                A temporary version of your scraper has been saved. To save it permanently you need to <a href="{% url login %}?next={% url handle_session_draft %}">sign in or create an account</a>.
            </div>
            {% ifequal rev 'draft' %}
                <div class="draft_warning">
                    Warning: this scraper has not been saved or committed. <a href="{% url login %}?next={% url handle_session_draft %}">Sign in or create an account</a> to save it permanently, or <a href="{% url delete_draft %}">discard changes</a>
                </div>
            {% endifequal %}

            {# Header #}
            <div class="editor_header">
                <div class="title">
                    <a id="aCloseEditor" href="{% url frontpage %}" title="Home">
                        <img src="{{ MEDIA_URL }}images/editor_logo.png" width="39" height="25"/>
                    </a>
                    <input id="id_title" type="text" title="Untitled" value="{{scraper.title}}" name="title"/>
                    <div class="page_tabs small">
                        {% if scraper.id %}
                            {% include 'codewiki/includes/tabs.html' %}
                        {% else %}
                            {% include 'codewiki/includes/cancel_button.html' %}
                        {% endif %}
                    </div>
                    <span id="border_hide"></span>
                </div>

            </div>

            {# Code editor #}
            <div class="editor_code" id="codeeditordiv">
               <textarea id="id_code" style="width:90%" rows="10" cols="80" name="code">{{code}}</textarea>
            </div>

            {# Controls #}
            <div class="editor_controls">
                <a id="menu_tutorials" class="helplink" href="#" title="Show useful commands">Quick help</a>
                {% ifnotequal scraper.language 'html' %}{% ifnotequal scraper.language 'javascript' %}
                  <input type="button" class="execute button" value="Run" name="run" id="run" title="Run this {{ wiki_type }} (Ctrl + R)"/>
                {% endifnotequal %}{% endifnotequal %}
                {% ifequal scraper.wiki_type 'view' %}{% ifnotequal scraper.language 'javascript' %}
                  <input type="button" class="button" value="Preview" name="preview" id="preview" title="Preview this view (Ctrl + P)"/>
                {% endifnotequal %}{% endifequal %}

                {# hidden if not necessary #}
                <select id="automode">
                    <option name="autotype" value="autotype" id="id_autotype">broadcast</option>
                    <option name="autosave" value="autosave" id="id_autosave"  {% if scraper.id %}selected{% endif %}>editing</option>
                    <option name="autoload" value="autoload" id="id_autoload" disabled>watching</option>
                    <option name="draft"    value="draft"    id="id_draft" {% if not scraper.id %}selected{% endif %}>draft editing</option>
                </select>

                {% ifequal scraper.wiki_type 'view' %}{% ifnotequal scraper.language 'html' %}{% ifnotequal scraper.language 'javascript' %}
                  <label for="id_urlquery" class="hide">Urlquery:</label>
                  <input id="id_urlquery" type="text" class="text" name="urlquery" title="URL query string passed to the view" /> 
                {% endifnotequal %}{% endifnotequal %}{% endifequal %}

                <img id="running_annimation" src="{{MEDIA_URL}}/images/running.gif"/>
                <span id="watcherstatus"></span>
            
                <div class="right">
                    <span class="last_saved"><span id="idlastrevnumber">{% if rev.rev %} Rev: {{rev.rev}} {% endif %}</span></span>
                    {% if scraper.id %}
                        <a id="aCloseEditor1" href="{% url code_overview scraper.wiki_type scraper.short_name %}">close editor</a>
                    {% else %}
                        <a id="aCloseEditor1" href="{% url frontpage %}">close editor</a>
                    {% endif %}
                    <input type="button" id="btnCommitPopup" class="commit button" name="action" value="Save" title="Save this {{scraper.wiki_type}} (Ctrl + S)"/>
                </div>
            </div>

            {# Consoles #}
            <div id="outputeditordiv" class="editor_output">
                <div class="tabs">
                    <ul>
                    {% ifnotequal scraper.language 'html' %}{% ifnotequal scraper.language 'javascript' %}
                        <li class="console">
                            <a href="#" title="Console output from scraper">Console</a>
                        </li>
                        <li class="data">
                            <a href="#" title="The data that this scraper generates">Data</a>
                        </li>
                        <li class="sources">
                            <a href="#" title="Pages you are scraping">Sources</a>
                        </li>
                    {% endifnotequal %}{% endifnotequal %}
                        <li class="chat">
                            <a href="#" title="Communicate to others">Chat</a>
                        </li>
                    </ul>
                </div>
                <div class="info">
                    <div id="output_console" class="output">
                        <div class="output_content"></div>
                    </div>
                    <div id="output_data" class="output">
                        <table class="output_content">
                            <tbody></tbody>
                        </table>
                    </div>
                    <div id="output_sources" class="output">
                        <div class="output_content"></div>
                    </div>
                    <div id="output_chat" class="output">
                        <table class="output_content">
                            <tbody></tbody>
                        </table>
                        <input type="text" name="chat_line" value="" id="chat_line"/>
                    </div>
                </div>
            </div>
      </div>
  
      <div id="feedback_messages">
      </div>

     {% comment %}
      {% if request.user.is_staff %}
      <div style="hidden">  {# for temporary safekeeping #}
        <p>
          <input type="checkbox" id="showautomode" checked />Always show automode dropdown.  
          <input type="checkbox" id="popuplinenumbers"/>Show line numbers in popup of cached page.
        </p>
          <p class="staff">
          You are using Codemirror-{{codemirrorversion}}.
          Last typed timestamp: <span class="staff" id="lasttypedtimestamp">...</span>
          </p>
      </div>
     {% endif %}
    {% endcomment %}
</body>
</html>
