<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}css/main.css" />
    <script>
        document.domain = document.domain;
    </script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery-1.3.2.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/json-min.js?{{settings.REVISION}}"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery.json-2.2.min.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/scraperwiki.js?{{settings.REVISION}}"></script>	
    <script src="http://{{ settings.ORBETED_DOMAIN }}:{{ settings.ORBETED_PORT }}/static/Orbited.js"></script>
    <script>Orbited.settings.streaming = false</script>
    <style type="text/css">
div#monitoroutput div{ border: thin red solid; overflow:auto; }

div#monitoroutput div#monitoringusers ul {  display:inline;   }
div#monitoroutput div#monitoringusers li {  border: thin blue solid; display:inline;   }

div#monitoroutput div#draftscraperusers ul {  display:inline;   }
div#monitoroutput div#draftscraperusers li {  border: thin blue solid; display:inline;   }
div#monitoroutput div#draftscraperusers li.running {  background-color:#afa;   }

div#monitoroutput ul#scraperentries {  display:block;  }
div#monitoroutput ul#scraperentries li.scraper {  border: thin red solid; display:block;  }
div#monitoroutput ul#scraperentries li.running {  background-color:#afa; }
div#monitoroutput ul#scraperentries li.scraper ul {  display:inline;  }
div#monitoroutput ul#scraperentries li.scraper ul li {  border: thin black solid; display:inline;  }

div#monitoroutput span.desc { background-color:black; color:white }; 

    </style>


    {# Needed for orbited, dont remove #}
    <script>document.domain = document.domain;</script>
    <script>Orbited.settings.streaming = false</script>

<script type="text/javascript">
$(document).ready(function() {
    var bConnected = false; 
    var username = $('#username').val(); 
    var userrealname = $('#userrealname').val(); 
    var isstaff = $('#isstaff').val(); 

    TCPSocket = Orbited.TCPSocket;
    var conn = new TCPSocket(); 
    var buffer = ""; 
    var receiverecordqueue = [ ]; 
    conn.open('localhost', '9010'); 

    conn.onopen = function(code)
    {
        if (conn.readyState == conn.READY_STATE_OPEN)
            mreadystate = 'Ready'; 
        else
            mreadystate = 'readystate=' + conn.readyState;
        $("#monitoroutput #connectionstatus").html('Connection opened: ' + mreadystate); 
        bConnected = true; 
        jdata = { "command":'connection_open', 
                  "umlmonitoring":"yes",
                  "username":username, 
                  "userrealname":userrealname, 
                  "isstaff":isstaff };
        send(jdata);
    }

    conn.onclose = function(code)
    {
        if (code == Orbited.Statuses.ServerClosedConnection)
            mcode = 'ServerClosedConnection'; 
        else if (code == Orbited.Errors.ConnectionTimeout)
            mcode = 'ConnectionTimeout'; 
        else  
            mcode = 'code=' + code;
        $("#monitoroutput #connectionstatus").html('<span style="background-color:black; color:white">Connection closed: ' + mcode+"</span>"); 
    }

    // should post up status in a little box
    conn.onread = function(ldata) 
    {
        //alert(ldata); 
        buffer = buffer+ldata;
        while (true) 
        {
            var linefeed = buffer.indexOf("\n"); 
            if (linefeed == -1)
                break; 
            sdata = buffer.substring(0, linefeed); 
            buffer = buffer.substring(linefeed+1); 
            sdata = sdata.replace(/[\s,]+$/g, '');  // trailing commas cannot be evaluated in IE
            if (sdata.length == 0)
                continue; 
            var jdata = undefined; 
            try {
                jdata = $.evalJSON(sdata);
            } catch(err) {
                alert("Malformed json: '''" + sdata + "'''"); 
            }

            if (jdata != undefined) 
            {
                receiverecordqueue.push(jdata); 
                if (receiverecordqueue.length == 1)
                    window.setTimeout(function() { receiveRecordFromQueue(); }, 1);  
            }
        }
    }

    function receiveRecordFromQueue() 
    {
        var jdata = undefined; 
        if (receiverecordqueue.length > 0) 
        {
            jdata = receiverecordqueue.shift(); 
            receiveRecord(jdata);
            if (receiverecordqueue.length >= 1)
                window.setTimeout(function() { receiveRecordFromQueue(); }, 1); 
        }
    }

    function getIDfromCChatname(cchatname)
    {
        vv = cchatname.split("|"); 
        if (vv[0])
            return vv[0]; 
        return vv[1]; // anonymous type
    }

    function getUserfromCChatname(cchatname)
    {
        vv = cchatname.split("|"); 
        if (vv[0])
            return "<a href=\"/profiles/"+vv[0]+"/\">"+vv[1]+"</a>"; 
        return vv[1]; // anonymous type
    }

    function getScraperfromScrapername(scrapername)
    {
        return "<a href=\"/scrapers/"+scrapername+"/edit/\"style=\"background-color:blue; color:white\">"+scrapername+"</a>"
    }

    //read data back from twisted
    function receiveRecord(jdata) 
    {
        $("#monitoroutput #jdatareceived").html($.toJSON(jdata)); 
        //alert($.toJSON(jdata)); 

        if (jdata.message)
            $("#monitoroutput #message").html(jdata.message); 

        if (jdata.umlmonitoringusers)
        {
            if (jdata.message_type == "umlstatus")
                $("#monitoroutput #monitoringusers ul").html(""); 
            for (i = 0; i < jdata.umlmonitoringusers.length; i++)
            {
                chatname = jdata.umlmonitoringusers[i][0]; 
                idchatname = "MON_" + getIDfromCChatname(chatname); 
                present = jdata.umlmonitoringusers[i][1]; 
                ele = "#monitoroutput #monitoringusers ul li#"+idchatname; 
                if (present)
                {
                    if (!$(ele).attr("id"))
                        $("#monitoroutput #monitoringusers ul").append("<li id=\""+idchatname+"\">"+getUserfromCChatname(chatname)+"</li>"); 
                }
                else
                    $(ele).remove(); 
            }
        }

        if (jdata.draftscraperusers)
        {
            if (jdata.message_type == "umlstatus")
                $("#monitoroutput #draftscraperusers ul").html(""); 
            for (i = 0; i < jdata.draftscraperusers.length; i++)
            {
                chatname = jdata.draftscraperusers[i][0]; 
                idchatname = "DRA_" + getIDfromCChatname(chatname); 
                present = jdata.draftscraperusers[i][1]; 
                running = jdata.draftscraperusers[i][2]; 
                ele = "#monitoroutput #draftscraperusers ul li#"+idchatname; 
                if (present)
                {
                    if (!$(ele).attr("id"))
                        $("#monitoroutput #draftscraperusers ul").append("<li id=\""+idchatname+"\">"+getUserfromCChatname(chatname)+"</li>"); 
                    if (running)
                        $(ele).addClass("running"); 
                    else
                        $(ele).removeClass("running"); 
                }
                else
                    $(ele).remove(); 
            }
        }

        if (jdata.scraperentries)
        {
            if (jdata.message_type == "umlstatus")
                $("#monitoroutput ul#scraperentries").html(""); 
            for (i = 0; i < jdata.scraperentries.length; i++)
            {
                scrapername = jdata.scraperentries[i][0]; 
                idscrapername = "SCR_" + scrapername; 
                present = jdata.scraperentries[i][1]; 
                running = jdata.scraperentries[i][2]; 
                scraperusers = jdata.scraperentries[i][3]; 
                ele = "#monitoroutput ul#scraperentries li#"+idscrapername; 
                if (present)
                {
                    if (!$(ele).attr("id"))
                        $("#monitoroutput ul#scraperentries").append("<li id=\""+idscrapername+"\" class=\"scraper\">"+getScraperfromScrapername(scrapername)+" <ul></ul></li>"); 
                    if (running)
                        $(ele).addClass("running"); 
                    else
                        $(ele).removeClass("running"); 
                    for (j = 0; j < scraperusers.length; j++)
                    {
                        chatname = scraperusers[j][0]; 
                        idcchatname = idscrapername + "_CHA_" + getIDfromCChatname(chatname); 
                        cpresent = scraperusers[j][1]; 
                        cele = ele + " ul li#"+idcchatname; 
                        if (cpresent)
                        {
                            if (!$(cele).attr("id"))
                                $(ele+" ul").append("<li id=\""+idcchatname+"\">"+getUserfromCChatname(chatname)+"</li>"); 
                        }
                        else
                            $(cele).remove(); 
                    }
                }
                else
                    $(ele).remove(); 
            }
        }

        if (jdata.message_type == "umlsavenote")
        {
            hidcchatname = "#SCR_" + jdata.scrapername + "_CHA_" + getIDfromCChatname(jdata.cchatname); 
            $(hidcchatname).css("background", "#f9f"); 
            setTimeout('$(hidcchatname).css("background", "white");', 2500);
        }
    }

    //send a message to the server
    function send(jdata) 
    {
        try {
            conn.send($.toJSON(jdata));  
        } catch(err) {
            alert("Send error: " + err); 
        }
    }


    var imgrefresharr = [ ]; 
    function refreshImages()
    {
        q = (new Date())
        $("#murefsh").html(q.toUTCString()); 
        for (i = 0; i < imgrefresharr.length; i++)
            $(imgrefresharr[i][0]).attr("src", imgrefresharr[i][1]+"?"+q.getTime()); 
        window.setTimeout(refreshImages, 2*60*1000);  
    }

    function refreshImagesInit()
    {
        $("img.irefresh").each(function(i) { 
            sidr = "ImgIR_"+i; 
            $(this).attr("id", sidr)
            imgrefresharr[i] = [ "#"+sidr, $(this).attr("src") ] 
        }); 
        window.setTimeout(refreshImages, 4000);  
    }
    refreshImagesInit(); 
}); 
</script>

<title>ScraperWiki UML status</title>
</head>

<body>


<form>
<fieldset>
    {# Hidden inputs for passing to js #}
    <input type="hidden" id="username" value="{{ user.username }}"/>
    <input type="hidden" id="userrealname" value="{{ user.get_profile.name }}"/>
    <input type="hidden" id="isstaff" value="{% if user.is_staff %}yes{% endif %}"/>
</fieldset>
</form>

<div id="monitoroutput" style="width:80%; margin-left:auto; margin-right:auto; border: thick black solid">
    <div id="connectionstatus">...</div>
    <div id="monitoringusers"><span class="desc">Monitoring:</span> <ul></ul></div>
    <div id="draftscraperusers"><span class="desc">Drafts:</span> <ul></ul></div>
    <ul id="scraperentries"></ul>
    <div id="jdatareceived">...</div>
    <div id="message">...</div>
</div>

<h3><a href="http://munin.scraperwiki.com/">Munin dashboard</a></h3>
<small>refreshed: <span id="murefsh"></span></small>
<table>
<tr>
  <th><a href="http://munin.scraperwiki.com/scraperwiki/horsell.scraperwiki.html">Django server (horsell)</a></th>
  <th><a href="http://munin.scraperwiki.com/scraperwiki/burbage.scraperwiki.html">Datastore server (burbage)</a></th>
</tr>

<tr>
  <td><img class="irefresh" src="http://munin.scraperwiki.com/scraperwiki/horsell.scraperwiki-cpu-day.png"></td>
  <td><img class="irefresh" src="http://munin.scraperwiki.com/scraperwiki/burbage.scraperwiki-mysql_queries-day.png"></td>
</tr>

<tr><th colspan="2"><a href="http://munin.scraperwiki.com/scraperwiki/burbage.scraperwiki.html">UML server (rush)</a></th></tr>
<tr>
  <td><img class="irefresh" src="http://munin.scraperwiki.com/scraperwiki/rush.scraperwiki-cpu-day.png"></td>
  <td><img class="irefresh" src="http://munin.scraperwiki.com/scraperwiki/rush.scraperwiki-load-day.png"></td>
</tr>
</table>

<div id="divLogo" style="float:left">
    <p><a href="{% url frontpage %}"><span class="hide">ScraperWiki</span></a></p>
</div>

<h1>UML Status</h1>
(does not update)
<p>Active UMLs: {% for activeuml in activeumls %}{{activeuml}}, {% endfor %}</p>

<table border="1" style="width:auto; margin:auto">
<tr><th>Scraper</th><th>time</th><th>kill button</th><th>Runid</th></tr>
{% for status in statusscrapers %}
  <tr>
    <td>
    {% if status.scraper %}
      <a href="{% url code_overview status.scraper.wiki_type status.scraper.short_name %}">{{status.scraper.title}}</a>
    {% else %}
      {{status.scraperID}}--
    {% endif %}
    </td>

    <td>
    {% if status.scraperrunevent %}
      <a href="{% url run_event status.scraperrunevent.id %}">{{status.runtime|floatformat}} seconds</a>
    {% else %}
      {{status.runtime|floatformat}} seconds
    {% endif %}
    </td>

    <td>
    {% if status.killable %}

    {% if status.scraperrunevent %}
    <form action="{% url scraper_killrunning status.runID status.scraperrunevent.id %}" method="post">
    {% else %}
    <form action="{% url scraper_killrunning status.runID %}" method="post">
    {% endif %}
        <input type="hidden" id="hidKillRun" name="killrun" value="1" />
        <input type="submit" id="btnKillRun" class="danger" value="Kill running scraper" />
    </form>
    {% endif %}
    </td>
    <td><small>{{status.runID}}</small></td>
  </tr>
{% endfor %}
</table>


<h1>Recent runs</h1>
<table border="1" style="width:auto; margin:auto">
  <tr>
    <th>Scraper</th>
    <th>Started</th>
    <th>Duration</th>
    <th>Output summary</th>
  </tr>
{% for run_event in events %}
  <tr>
    <td><a href="{% url code_overview run_event.scraper.wiki_type run_event.scraper.short_name %}">{{run_event.scraper.title}}</a></td> 
    <td>{{run_event.run_started|timesince}} ago (<small>{{run_event.run_started}}</small>)</td> 
    <td>{{run_event.getduration}} seconds</td> 
    <td><a href="{% url run_event run_event.id %}">{{run_event.outputsummary}}</a></td>
  </tr>
{% endfor %}
</table>


</body>
</html>
