<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}css/main.css" />
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery-1.3.2.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/json-min.js?{{settings.REVISION}}"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery.json-2.2.min.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/scraperwiki.js?{{settings.REVISION}}"></script>		
    <script src="http://{{ settings.ORBETED_DOMAIN }}:{{ settings.ORBETED_PORT }}/static/Orbited.js"></script>

    {# Needed for orbited, dont remove #}
    <script>document.domain = document.domain;</script>
    <script>Orbited.settings.streaming = false</script>

<script type="text/javascript">
$(document).ready(function() {
    var bConnected = false; 
    var username = $('#username').val(); 
    var userrealname = $('#userrealname').val(); 
    var isstaff = $('#isstaff').val(); 

    TCPSocket = Orbited.TCPSocket;
    var conn = new TCPSocket(); 
    conn.open('localhost', '9010'); 


    conn.onopen = function(code)
    {
        if (conn.readyState == conn.READY_STATE_OPEN)
            mreadystate = 'Ready'; 
        else
            mreadystate = 'readystate=' + conn.readyState;
        alert('Connection opened: ' + mreadystate); 
        bConnected = true; 
        data = { "command":'connection_open', 
                 "umlmonitoring":"yes",
                 "username":username, 
                 "userrealname":userrealname, 
                 "isstaff":isstaff };
        send(data);
    }

    conn.onclose = function(code)
    {
        if (code == Orbited.Statuses.ServerClosedConnection)
            mcode = 'ServerClosedConnection'; 
        else if (code == Orbited.Errors.ConnectionTimeout)
            mcode = 'ConnectionTimeout'; 
        else  
            mcode = 'code=' + code;
        alert(mcode); 
    }

    // should post up status in a little box
    conn.onread = function(ldata) 
    {
        alert(ldata); 
    }

    //send a message to the server
    function send(json_data) 
    {
        try {
            conn.send($.toJSON(json_data));  
        } catch(err) {
            alert("Send error: " + err); 
        }
    }

}); 
</script>

    <title>ScraperWiki UML status</title>
</head>

<body>
<div id="divLogo" style="float:left">
    <p>
        <a href="{% url frontpage %}"><span class="hide">ScraperWiki</span></a>
    </p>
</div>

<form>
<fieldset>
    {# Hidden inputs for passing to js #}
    <input type="hidden" id="username" value="{{ user.username }}"/>
    <input type="hidden" id="userrealname" value="{{ user.get_profile.name }}"/>
    <input type="hidden" id="isstaff" value="{% if user.is_staff %}yes{% endif %}"/>
</fieldset>
</form>

<h1>UML Status</h1>
<table border="1" style="width:auto; margin:auto">
<tr><th>Scraper</th><th>time</th><th>kill button</th><th>Runid</th></tr>
{% for status in statusscrapers %}
  <tr>
    <td>
    {% if status.scraper %}
      <a href="{% url code_overview status.scraper.wiki_type status.scraper.short_name %}">{{status.scraper.title}}</a>
    {% else %}
      {{status.scraperID}}--
    {% endif %}
    </td>

    <td>
    {% if status.scraperrunevent %}
      <a href="{% url run_event status.scraperrunevent.id %}">{{status.runtime|floatformat}} seconds</a>
    {% else %}
      {{status.runtime|floatformat}} seconds
    {% endif %}
    </td>

    <td>
    {% if status.killable %}

    {% if status.scraperrunevent %}
    <form action="{% url scraper_killrunning status.runID status.scraperrunevent.id %}" method="post">
    {% else %}
    <form action="{% url scraper_killrunning status.runID %}" method="post">
    {% endif %}
        <input type="hidden" id="hidKillRun" name="killrun" value="1" />
        <input type="submit" id="btnKillRun" class="danger" value="Kill running scraper" />
    </form>
    {% endif %}
    </td>
    <td><small>{{status.runID}}</small></td>
  </tr>
{% endfor %}
</table>


<h1>Recent runs</h1>
<table border="1" style="width:auto; margin:auto">
  <tr>
    <th>Scraper</th>
    <th>Started</th>
    <th>Duration</th>
    <th>Output summary</th>
  </tr>
{% for run_event in events %}
  <tr>
    <td><a href="{% url code_overview run_event.scraper.wiki_type run_event.scraper.short_name %}">{{run_event.scraper.title}}</a></td> 
    <td>{{run_event.run_started|timesince}} ago (<small>{{run_event.run_started}}</small>)</td> 
    <td>{{run_event.getduration}} seconds</td> 
    <td><a href="{% url run_event run_event.id %}">{{run_event.outputsummary}}</a></td>
  </tr>
{% endfor %}
</table>


<h1><a href="http://munin.scraperwiki.com/">Munin dashboard</a></h1>
<table>
<tr>
  <th><a href="http://munin.scraperwiki.com/scraperwiki/horsell.scraperwiki.html">Django server (horsell)</a></th>
  <th><a href="http://munin.scraperwiki.com/scraperwiki/burbage.scraperwiki.html">Datastore server (burbage)</a></th>
</tr>

<tr>
  <td><img src="http://munin.scraperwiki.com/scraperwiki/horsell.scraperwiki-cpu-day.png"></td>
  <td><img src="http://munin.scraperwiki.com/scraperwiki/burbage.scraperwiki-mysql_queries-day.png"></td>
</tr>

<tr><th colspan="2"><a href="http://munin.scraperwiki.com/scraperwiki/burbage.scraperwiki.html">UML server (rush)</a></th></tr>
<tr>
  <td><img src="http://munin.scraperwiki.com/scraperwiki/rush.scraperwiki-cpu-day.png"></td>
  <td><img src="http://munin.scraperwiki.com/scraperwiki/rush.scraperwiki-load-day.png"></td>
</tr>
</table>

</body>
</html>
