{% extends "codewiki/scraper_base.html" %}
{% load humanize %}
{% load sparkline %}
{% load schedule %}
{% block tab %}
{% load markup %}
{% load screen_shot %}

<fieldset>
    <input type="hidden" id="hidScheduleOptions" value="{ {% for schedule_option, schedule_text in schedule_options %}'{{schedule_option|safe}}':'{{schedule_text|safe}}', {% endfor %} }" />
</fieldset>

<div class="content full">
    <div class="data_viewer">
        {% if data.rows %}
            <div>
                <table class="data">
                    <thead>
                        <tr>
                            {% for heading in data.headings %}
                                <th width="120">{{ heading }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in data.rows %}
                            <tr>
                                {% for value in row %}
                                    <td>{{ value|truncatewords_html:30|urlizetrunc:30 }}</td>
                                {% endfor %}
                            </tr>
                        {% endfor %}    
                    </tbody>
                </table>
            </div>
        {% else %}
            <div>
            <table class="data">
                    <tbody>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    </tbody>
                </table>
            </div>
    	    <div class="info_unpublished">
    	            This scraper is being worked on <br/>and there is no data to display yet
    	    </div>
        {% endif %}
        <div class="content_footer">
            <p>
                This dataset has a total of {{ scraper.record_count }} records and 
                {% if lastscraperrunevent %}
                  {% ifequal lastscraperrunevent.pid -1 %}
                     last ran {{lastscraperrunevent.run_started|timesince}} ago 
                     for <a href="{% url run_event lastscraperrunevent.id%}">{{lastscraperrunevent.getduration}} seconds</a>.
                  {% else %}
                     <a href="{% url run_event lastscraperrunevent.id%}">is currently running</a>.
                  {% endifequal %}
                {% else %}
                   has not been run yet.
                {% endif %}

                {% if scraper.license_link %}
                    The license for this data is {{scraper.license|lower|default:"&nbsp;"}} and a copy can be found on <a href="{{scraper.license_link}}">this page</a>.
                    {% if user.is_authenticated %}
                        <a href="{% url scraper_admin scraper.short_name %}">[edit license]</a>
                    {% else %}
                        <a href="{% url login %}?next={% url code_overview 'scraper' scraper.short_name %}">[sign in to edit license]</a>
                    {% endif %}
                {% else %}
                    The license for this dataset is unknown, {% if user.is_authenticated %}<a href="{% url scraper_admin scraper.short_name %}">please add a link to the license if you are able to locate it</a>{% else %}<a href="{% url login %}?next={% url code_overview 'scraper' scraper.short_name %}">please sign in and add a link to the license if you are able to locate it</a>{% endif %}.
                {% endif %}
            </p>
        </div>
    </div>
</div>

<div class="content full">
    <h2>About this scraper {% if user.is_authenticated %}<a href="{% url scraper_admin scraper.short_name %}" id="aEditAboutScraper" class="edit">[edit description]</a>{% else %}<a href="{% url login %}?next={% url code_overview 'scraper' scraper.short_name %}" class="edit">[sign in to edit description]</a>{% endif %}</h2>
    <div class="text_wiki">
        <div id="divAboutScraper">{{ scraper.description|textile }}</div>
    </div>
</div>

<div id="divScraperTags" class="content full">
    <h2>Tags {% if user.is_authenticated %}<a href="{% url scraper_admin scraper.short_name %}" id="aAddTags" class="edit">[add a tag]</a>{% else %}<a href="{% url login %}?next={% url code_overview 'scraper' scraper.short_name %}" class="edit">[sign in to add a tag]</a>{% endif %}</h2>
    {% if scraper_tags %}
        <ul class="tags">
            {% for tag in scraper_tags %}
                <li><a href="{% url single_tag tag %}">{{ tag }}</a></li>
            {% endfor %}
        </ul>
    {% else %}
        <p>
            Adding tags make sense of all the datasets on ScraperWiki
        </p>
    {% endif %}
    <div id="divEditTags"></div>
</div>

{% if user.is_staff %}
<div class="content full staff">
    <h2>Views using this data from this scraper</h2>    
    <ul class="views">
        {% if related_views %}
            {% for related_view in related_views %}
                <li>
                    <a href="{% url code_overview related_view.wiki_type related_view.short_name %}" class="screenshot">{% screen_shot related_view %}</a>
                    <a href="{% url code_overview related_view.wiki_type related_view.short_name %}">{{related_view.title}}</a>
                </li>
            {% endfor %}
        {% endif %}        
        <li class="new"><a href="#" class="editor_view">Create a new view</a></li>
    </ul>
    <br class="clear"/>
</div>
{% endif %}

<div class="content col left">
    <h3>Contributors</h3>
    {% include 'codewiki/includes/contributors.html' %}
</div>

<div class="content col right">
    <h3>Schedule {% if user.is_authenticated %}<a href="{% url scraper_admin scraper.short_name %}" id="aEditSchedule" class="edit">[edit schedule]</a>{% endif %}</h3>
    <p>
      This scraper is scheduled to run <span id="spnRunInterval">{{scraper.run_interval|schedule}}</span>
      {% ifnotequal scraper.next_run.year 9999 %}
         (next in {{scraper.next_run|timeuntil}})
      {% endifnotequal %}
    </p>
    <p>{% sparkline scraper.scraper_sparkline_csv 'medium' %}</p>

    {% if user_owns_it and not scraper.published %}
      <div id="publishScraper">
        <h3>Publish</h3>
        <p>By default all scrapers are now published. This scraper was created before that policy. This button allows you to publish this scraper.</p>
        <form>
          <input type="submit" class="small button" id="publishScraperButton" value="Publish"/>
        </form>
        <br/>
      </div>
    {% endif %}
    
    <h3>Delete &amp; reset</h3>
    {% if user_owns_it %}    
        <form action="{% url scraper_delete_data scraper.short_name %}" method="post">
            <input type="hidden" id="hidDeleteData" name="delete_data" value="1" />
            <input type="submit" id="btnClearDatastore" class="danger" value="Clear the datastore?" />
            <p>Removes all data for this scraper. There is no undo.</p>
        </form>
        <form action="{% url scraper_delete_scraper scraper.short_name %}" method="post">
            <input type="hidden" name="delete_scraper" value="1" />
            <input type="submit" id="btnDeleteScraper" class="danger" value="Delete this scraper?" />
            <p>Deletes this scraper and all its data. There is no undo.</p>
        </form>
        <form action="{% url scraper_schedule_scraper scraper.short_name %}" method="post">
            <input type="hidden" name="schedule_scraper" value="1" />
            <input type="submit" id="btnScheduleScraper" class="danger" value="Schedule this scraper?" />
            <p>Schedule next</p>
        </form>
    {% else %}
        <p class="infobox">Only the creator of a scraper can delete or reset it.</p>
    {% endif %}

    {% if user.is_staff %}
    <form action="{% url scraper_run_scraper scraper.short_name %}" method="post" class="staff">
        <input type="hidden" name="run_scraper" value="1" />
        <input type="submit" id="btnRunScraper" class="danger" value="Run this scraper?" />
        <p>Runs this scraper as though from the schedule. (Staff only)</p>
    </form>
    {% endif %}

</div>
<br class="clear"/>
{% endblock %}

{% block run_script %}
    {% if user.is_authenticated %}
        var scraper_short_name = '{{scraper.short_name}}';
        setupScraperEditInPlace('scraper', '{{scraper.short_name}}');
        setupButtonConfirmation("btnClearDatastore", "Are you absolutely sure? THERE IS NO UNDO, clicking 'ok' will delete all existing data for this scraper.");
        setupButtonConfirmation("btnDeleteScraper", "Are you absolutely sure? THERE IS NO UNDO, clicking 'ok' will delete this scraper and it's data.");
    {% endif %}
{% endblock %}
