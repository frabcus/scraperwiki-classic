{% extends "codewiki/scraper_base.html" %}
{% load humanize %}
{% load schedule %}
{% block tab %}
{% load markup %}
{% load screen_shot %}

<fieldset>
    <input type="hidden" id="hidScheduleOptions" value="{ {% for schedule_option, schedule_text in schedule_options %}'{{schedule_option|safe}}':'{{schedule_text|safe}}', {% endfor %} }" />
    <input type="hidden" id="hidLicenseChoices" value="{ {% for name, text in license_choices %}'{{name}}':'{{text}}', {% endfor %} }" />
</fieldset>

<div class="content full">
    <div class="data_viewer">
        {% if data.rows %}
            <div>
                {% if user.is_staff %}
                <form class="staff" action="{% url scraper_converttosqlitedatastore scraper.short_name %}" method="post">
                    <input type="submit" name="converttosqlitedatastore" value="converttosqlitedatastore"/>
                </form>
                {% endif %}
                <table class="data">
                    <thead>
                        <tr>
                            {% for heading in data.headings %}
                                <th width="120">{{ heading }}</th>
                            {% endfor %}
                        </tr>
                        <tr>
                            <th cols="{{data.headings|length}}" class="morerow">...</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in data.rows %}
                            <tr class="row">
                                {% for value in row %}
                                    <td>{{ value|truncatewords_html:30|urlizetrunc:30 }}</td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                        {% for row in data.morerows %}
                            <tr class="morerow">
                                {% for value in row %}
                                    <td>{{ value|truncatewords_html:30|urlizetrunc:30 }}</td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="content_footer">
              <p>
                 {% if scraper.record_count %}
                    This dataset has a total of {{scraper.record_count}} records.
                 {% endif %}
              </p>
            </div>
        {% endif %}

        {% if sqlitedata %}
             {% if user.is_staff %}
              <div class="staff" style="float: right">
              <a href="#" id="popupinteractivesqlite">Interactive</a> | 
              <span>
                <a class="sqlite_view_schema" >show schema{{sqlitedata.items|pluralize}}</a>
                <a class="sqlite_view_schema" >hide schema{{sqlitedata.items|pluralize}}</a>
              </span>
              </div>
             {% endif %}
           <ul id="sqlite_schema">
            {% for sqltablename, sqltabledata in sqlitedata.items %}
              <li>{{sqltabledata.sql}}</li>
            {% endfor %}
           </ul>
    	   <ul class="data_tabs">
             {% for sqltablename, sqltabledata in sqlitedata.items %}
                <li id="data_tab_{{forloop.counter}}" class="data_tab"> 
                    {{sqltablename}} ({{sqltabledata.count}}  rows)
                </li>
             {% endfor %}
            </ul>
          {% for sqltablename, sqltabledata in sqlitedata.items %}
            <div id="data_content_{{forloop.counter}}" class="data_content">
            <table class="data">
              <thead>
                 <tr>{% for heading in sqltabledata.keys %}<th width="120">{{ heading }}</th>{% endfor %}</tr>
              </thead>
              <tbody>
                 {% for row in sqltabledata.rows %}
                    <tr class="row">{% for value in row %}<td>{% if value %}{{ value|truncatewords_html:30|urlizetrunc:30 }}{% endif %}</td>{% endfor %}</tr>
                 {% endfor %}
              </tbody>
            </table>
            </div>
          {% endfor %}
          </div>

          <div class="content_footer">
             <p>This dataset has a total of {{ scraper.record_count }} records in {{ sqlitedata|length }} table{{ sqlitedata|length|pluralize }}</p>
          </div>
        {% endif %}

        {% if not data.rows %}{% if not sqlitedata %}
            <div>
                <table class="data">
                    <tbody>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="info_unpublished">
                    This scraper is being worked on <br/>and there is no data to display yet
            </div>
        {% endif %}{% endif %}
    </div>
</div>

<div class="content full">
    <h2>About this scraper 
        {% if user.is_authenticated %}<a href="#" id="aEditAboutScraper" class="edit">[edit description]</a>{% else %}<a href="{% url login %}?next={% url code_overview 'scraper' scraper.short_name %}" class="edit">[sign in to edit description]</a>{% endif %}
        {% if user.is_staff %}
          <span class="staff">
          {% if ckanresource %}
            <a href="{{ckanresource.ckan_url}}">Go to CKAN page</a>
          {% endif %}
          {% if ckansubmit %}
            <a href="{{ckansubmit}}">Submit to CKAN</a>
          {% endif %}
          </span>
        {% endif %}
    </h2>
    <div class="text_wiki">
        <div id="divAboutScraper">{{ scraper.description|textile }}</div>
    </div>
</div>

<div id="divScraperTags" class="content full">
    <h2>Tags {% if user.is_authenticated %}<a href="#" id="aEditTags" class="edit">[edit tags]</a>{% else %}<a href="{% url login %}?next={% url code_overview 'scraper' scraper.short_name %}" class="edit">[sign in to add a tag]</a>{% endif %}</h2>
    <label id="labelEditTags" for="divEditTags">Comma separated list of tags:</label><div id="divEditTags"></div>
    <ul class="tags">
        {% for tag in scraper_tags %}
            <li><a href="{% url single_tag tag %}">{{ tag }}</a></li>
        {% endfor %}
    </ul>
    {% if not scraper_tags %}
        <p>
            Adding tags helps makes sense of all the datasets on ScraperWiki.
        </p>
    {% endif %}
</div>

<div class="content full">
    <h2>Views using this data from this scraper</h2>    
    <ul class="views">
        {% if related_views %}
            {% for related_view in related_views %}
                <li>
                    <a href="{% url code_overview related_view.wiki_type related_view.short_name %}" class="screenshot">{% screen_shot related_view %}</a>
                    <a href="{% url code_overview related_view.wiki_type related_view.short_name %}">{{related_view.title}}</a>
                </li>
            {% endfor %}
        {% endif %}        
        <li class="new"><a href="{% url choose_template 'view' %}" class="editor_view">Create a new view</a></li>
    </ul>
    <br class="clear"/>
</div>

<div class="content col left">
    <h3>Contributors</h3>
    {% include 'codewiki/includes/contributors.html' %}

    <h3>License {% if user.is_authenticated %}<a href="#" id="aEditLicense" class="edit">[edit license]</a>{% endif %}</h3>
    This dataset is licensed as: <span id="spnLicenseChoice">{{scraper.license}}</span>
    <p>  </p>
    
</div>

<div class="content col right">
    <h3>Schedule {% if user.is_authenticated %}<a href="#" id="aEditSchedule" class="edit">[edit schedule]</a>{% endif %}</h3>
    <p>
        This scraper 
        {% if lastscraperrunevent %}
          {% ifequal lastscraperrunevent.pid -1 %}
             last ran {{lastscraperrunevent.run_started|timesince}} ago 
             for <a href="{% if lastscraperrunevent.run_id %}{% url run_event lastscraperrunevent.run_id %}{% else %}{% url run_event lastscraperrunevent.id %}{% endif %}">{{lastscraperrunevent.getduration}} seconds</a>.
          {% else %}
            {% if lastscraperrunevent.run_id %}
                <a href="{% url run_event lastscraperrunevent.run_id %}">is currently running</a>.
            {% else %}
                <i><a href="{% url run_event lastscraperrunevent.id %}">is running without an id</a></i>.
             {% endif %}
          {% endifequal %}
        {% else %}
           has not been run yet.
        {% endif %}
    </p>
    <p>
      <span title="Exact time of next run: {{scraper.next_run}}">
      It is scheduled to run <span id="spnRunInterval">{{scraper.scraper.run_interval|schedule}}</span>
      {% ifnotequal scraper.next_run.year 9999 %}
        {% ifequal scraper.next_run|timeuntil '0 minutes' %}
          (next run ASAP).
        {% else %}
          (next in {{scraper.next_run|timeuntil}}).
        {% endifequal %} 
      {% else %}
        (no future run scheduled).
      {% endifnotequal %}
      </span>
    </p>

    {% if user_owns_it %}    
        {% ifnotequal scraper.next_run|timeuntil '0 minutes' %}
            <form action="{% url scraper_schedule_scraper scraper.short_name %}" method="post">
                <input type="hidden" name="schedule_scraper" value="1" />
                <input type="submit" id="btnScheduleScraper" class="" value="Schedule next run ASAP" />
            </form>
            <br/>
        {% endifnotequal %}
    {% endif %}

    {% if user_owns_it and not scraper.published %}
      <div id="publishScraper">
        <h3>Publish</h3>
        <p>By default all scrapers are now published. This scraper was created before that policy. This button allows you to publish this scraper.</p>
        <form>
          <input type="submit" class="small button" id="publishScraperButton" value="Publish"/>
        </form>
        <br/>
      </div>
    {% endif %}
    
    <h3>Delete &amp; reset</h3>
    {% if user_owns_it or user.is_staff %}    
        {% if user.is_staff and not user_owns_it %}
            <div class="staff">
        {% endif %}
        <form action="{% url scraper_delete_data scraper.short_name %}" method="post">
            <input type="hidden" id="hidDeleteData" name="delete_data" value="1" />
            <input type="submit" id="btnClearDatastore" class="danger" value="Clear the datastore?" />
            <p>Removes all data for this scraper. There is no undo.</p>
        </form>
        <form action="{% url scraper_delete_scraper 'scraper' scraper.short_name %}" method="post">
            <input type="hidden" name="delete_scraper" value="1" />
            <input type="submit" id="btnDeleteScraper" class="danger" value="Delete this scraper?" />
            <p>Deletes this scraper and all its data. There is no undo.</p>
        </form>
        {% if user.is_staff and not user_owns_it %}
            </div>
        {% endif %}
    {% else %}
        <p class="infobox">Only the creator of a scraper can delete or reset it.</p>
    {% endif %}

    {% if user.is_staff %}
    <p class="staff"><b>Go to scraper on <a href="/admin/codewiki/scraper/{{scraper.pk}}/">admin page</a></b></p>

    <form action="{% url scraper_run_scraper scraper.short_name %}" method="post" class="staff">
        <input type="hidden" name="run_scraper" value="1" />
        <input type="submit" id="btnRunScraper" class="" value="Run now (as if scheduled)" />
        <p>If this scraper's schedule is overdue, runs it immediately. (Staff only)</p>
    </form>

    <form action="{% url scraper_screenshoot_scraper scraper.wiki_type scraper.short_name %}" method="post" class="staff">
        <input type="hidden" name="screenshoot_scraper" value="1" />
        <input type="submit" id="btnScreenshootScraper" class="" value="Screenshoot this scraper" />
        <p>Take a screenshot of this scraper. (Staff only)</p>
    </form>
    {% endif %}

</div>
<br class="clear"/>
{% endblock %}

{% block run_script_outer %}
    {{block.super}}

<script>
{% if user.is_authenticated %}
    setupButtonConfirmation("btnClearDatastore", "Are you sure? Clicking 'ok' will delete all SCRAPED DATA and METADATA.");
    setupButtonConfirmation("btnDeleteScraper", "Are you sure? Clicking 'ok' will delete THE ENTIRE SCRAPER and it's data.");
{% endif %}

// detect clicks on data tabs
$('.data_tab').click(function data_tab_clicked() 
{
    // do nothing if already selected
    if ($(this).hasClass('selected')) 
        return;
    
    // make tab selected
    $('.data_tab').removeClass('selected'); // all
    $(this).addClass('selected');

    // show and hide
    $('.data_content').hide(); // all
    var tab_content_name = $(this).attr('id').replace('data_tab', 'data_content');
    $('#' + tab_content_name).show();
}); 
$('#data_tab_1').click();


$('.sqlite_view_schema:last').hide(); 
$('#sqlite_schema').hide(); 
$('.sqlite_view_schema').click( function() 
{
    $('#sqlite_schema').toggle(); 
    $('.sqlite_view_schema').toggle(); 
});


$("#popupinteractivesqlite").click(function() 
{
    var url = "http://{{settings.VIEW_DOMAIN}}{% url rpcexecute 'quickcheck_datastore' %}?src="+decodeURIComponent('{{scraper.short_name}}'); 
    $.modal('<iframe width="100%" height="100%" src='+url+'></iframe>', 
    {
        overlayClose: true,
        containerCss: { borderColor:"#0ff", height:"80%", padding:0, width:"90%" }, 
        overlayCss: { cursor:"auto" }, 
        onShow: function() 
        {
            $('.simplemodal-wrap').css("overflow", "hidden"); 
            $('.simplemodal-wrap iframe').width($('.simplemodal-wrap').width()-2); 
            $('.simplemodal-wrap iframe').height($('.simplemodal-wrap').height()-2); 
        }
    }); 
}); 

</script>
{% endblock %}

