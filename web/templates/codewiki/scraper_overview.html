{% extends "codewiki/scraper_base.html" %}
{% load humanize %}
{% load schedule %}
{% block tab %}
{% load markup %}
{% load screen_shot %}

<fieldset>
    <input type="hidden" id="hidScheduleOptions" value="{ {% for schedule_option, schedule_text in schedule_options %}'{{schedule_option|safe}}':'{{schedule_text|safe}}', {% endfor %} }" />
    <input type="hidden" id="hidLicenseChoices" value="{ {% for name, text in license_choices %}'{{name}}':'{{text}}', {% endfor %} }" />
</fieldset>

<div class="content full">
    <div class="data_viewer">
        <ul class="code_about">
          <li><a id="aHideTable" class="edit">[hide table]</a></li>
          <li><a id="aShowTable" class="edit">[show table]</a></li>
          <li><a id="aShowMore" class="edit">[show more]</a></li>
          <li><a id="aShowLess" class="edit">[show less]</a></li>
        </ul>

        {% if data.rows %}
            <div>
                {% if user.is_staff %}
                <form class="staff" action="{% url scraper_converttosqlitedatastore scraper.short_name %}" method="post">
                    <input type="submit" name="converttosqlitedatastore" value="converttosqlitedatastore"/>
                </form>
                {% endif %}
                <table class="data">
                    <thead>
                        <tr>
                            {% for heading in data.headings %}
                                <th width="120">{{ heading }}</th>
                            {% endfor %}
                        </tr>
                        <tr>
                            <th cols="{{data.headings|length}}" class="morerow">...</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in data.rows %}
                            <tr class="row">
                                {% for value in row %}
                                    <td>{{ value|truncatewords_html:30|urlizetrunc:30 }}</td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                        {% for row in data.morerows %}
                            <tr class="morerow">
                                {% for value in row %}
                                    <td>{{ value|truncatewords_html:30|urlizetrunc:30 }}</td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}

        {% if sqlitedata %}
          {% for sqltablename, sqltabledata in sqlitedata.items %}
            <table class="data">
              <thead>
                 <tr><th colspan="{{sqltabledata.keys|length}}">
                    Sample from sqlite table <b><a title="{{sqltabledata.sql}}">{{sqltablename}}</a></b> which has {{sqltabledata.count}} rows
                 </th></tr>
                 <tr>{% for heading in sqltabledata.keys %}<th width="120">{{ heading }}</th>{% endfor %}</tr>
              </thead>
              <tbody>
                 {% for row in sqltabledata.rows %}
                    <tr class="row">{% for value in row %}<td>{% if value %}{{ value|truncatewords_html:30|urlizetrunc:30 }}{% endif %}</td>{% endfor %}</tr>
                 {% endfor %}
              </tbody>
            </table>
          {% endfor %}
        {% endif %}

        {% if not data.rows %}{% if not sqlitedata %}
            <div>
                <table class="data">
                    <tbody>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="info_unpublished">
                    This scraper is being worked on <br/>and there is no data to display yet
            </div>
        {% endif %}{% endif %}

        <div class="content_footer">
            <p>
                {% if scraper.record_count %}This dataset has a total of {{ scraper.record_count }} records.{% endif %}
            </p>
        </div>
    </div>
</div>

<div class="content full">
    <h2>About this scraper {% if user.is_authenticated %}<a href="#" id="aEditAboutScraper" class="edit">[edit description]</a>{% else %}<a href="{% url login %}?next={% url code_overview 'scraper' scraper.short_name %}" class="edit">[sign in to edit description]</a>{% endif %}</h2>
    <div class="text_wiki">
        <div id="divAboutScraper">{{ scraper.description|textile }}</div>
    </div>
</div>

<div id="divScraperTags" class="content full">
    <h2>Tags {% if user.is_authenticated %}<a href="#" id="aEditTags" class="edit">[edit tags]</a>{% else %}<a href="{% url login %}?next={% url code_overview 'scraper' scraper.short_name %}" class="edit">[sign in to add a tag]</a>{% endif %}</h2>
    <ul class="tags">
        {% for tag in scraper_tags %}
            <li><a href="{% url single_tag tag %}">{{ tag }}</a></li>
        {% endfor %}
    </ul>
    {% if not scraper_tags %}
        <p>
            Adding tags make sense of all the datasets on ScraperWiki
        </p>
    {% endif %}
    <label id="labelEditTags" for="divEditTags">Comma separated list of tags:</label><div id="divEditTags"></div>
</div>

<div class="content full">
    <h2>Views using this data from this scraper</h2>    
    <ul class="views">
        {% if related_views %}
            {% for related_view in related_views %}
                <li>
                    <a href="{% url code_overview related_view.wiki_type related_view.short_name %}" class="screenshot">{% screen_shot related_view %}</a>
                    <a href="{% url code_overview related_view.wiki_type related_view.short_name %}">{{related_view.title}}</a>
                </li>
            {% endfor %}
        {% endif %}        
        <li class="new"><a href="{% url choose_template 'view' %}" class="editor_view">Create a new view</a></li>
    </ul>
    <br class="clear"/>
</div>

<div class="content col left">
    <h3>Contributors</h3>
    {% include 'codewiki/includes/contributors.html' %}

    <h3>License {% if user.is_authenticated %}<a href="#" id="aEditLicense" class="edit">[edit license]</a>{% endif %}</h3>
    This dataset is licensed as: <span id="spnLicenseChoice">{{scraper.license}}</span>
    <p>  </p>
    
</div>

<div class="content col right">
    <h3>Schedule {% if user.is_authenticated %}<a href="#" id="aEditSchedule" class="edit">[edit schedule]</a>{% endif %}</h3>
    <p>
        This scraper 
        {% if lastscraperrunevent %}
          {% ifequal lastscraperrunevent.pid -1 %}
             last ran {{lastscraperrunevent.run_started|timesince}} ago 
             for <a href="{% if lastscraperrunevent.run_id %}{% url run_event lastscraperrunevent.run_id %}{% else %}{% url run_event lastscraperrunevent.id %}{% endif %}">{{lastscraperrunevent.getduration}} seconds</a>.
          {% else %}
             {% if lastscraperrunevent.run_id %}
                <a href="{% url run_event lastscraperrunevent.run_id %}">is currently running</a>.
            {% else %}
                <i><a href="{% url run_event lastscraperrunevent.id %}">is running without an id</a></i>.
             {% endif %}
          {% endifequal %}
        {% else %}
           has not been run yet.
        {% endif %}
    </p>
    <p>
      <span title="Exact time of next run: {{scraper.next_run}}">
      It is scheduled to run <span id="spnRunInterval">{{scraper.run_interval|schedule}}</span>
      {% ifnotequal scraper.next_run.year 9999 %}
        {% ifequal scraper.next_run|timeuntil '0 minutes' %}
          (next run ASAP).
        {% else %}
          (next in {{scraper.next_run|timeuntil}}).
        {% endifequal %} 
      {% else %}
        (no future run scheduled).
      {% endifnotequal %}
      </span>
    </p>

    {% if user_owns_it %}    
        {% ifnotequal scraper.next_run|timeuntil '0 minutes' %}
            <form action="{% url scraper_schedule_scraper scraper.short_name %}" method="post">
                <input type="hidden" name="schedule_scraper" value="1" />
                <input type="submit" id="btnScheduleScraper" class="" value="Schedule next run ASAP" />
            </form>
            <br/>
        {% endifnotequal %}
    {% endif %}

    {% if user_owns_it and not scraper.published %}
      <div id="publishScraper">
        <h3>Publish</h3>
        <p>By default all scrapers are now published. This scraper was created before that policy. This button allows you to publish this scraper.</p>
        <form>
          <input type="submit" class="small button" id="publishScraperButton" value="Publish"/>
        </form>
        <br/>
      </div>
    {% endif %}
    
    <h3>Delete &amp; reset</h3>
    {% if user_owns_it %}    
        <form action="{% url scraper_delete_data scraper.short_name %}" method="post">
            <input type="hidden" id="hidDeleteData" name="delete_data" value="1" />
            <input type="submit" id="btnClearDatastore" class="danger" value="Clear the datastore?" />
            <p>Removes all data for this scraper. There is no undo.</p>
        </form>
        <form action="{% url scraper_delete_scraper 'scraper' scraper.short_name %}" method="post">
            <input type="hidden" name="delete_scraper" value="1" />
            <input type="submit" id="btnDeleteScraper" class="danger" value="Delete this scraper?" />
            <p>Deletes this scraper and all its data. There is no undo.</p>
        </form>
    {% else %}
        <p class="infobox">Only the creator of a scraper can delete or reset it.</p>
    {% endif %}

    {% if user.is_staff %}
    <p class="staff"><b>Go to scraper on <a href="/admin/codewiki/scraper/{{scraper.pk}}/">admin page</a></b></p>

    <form action="{% url scraper_run_scraper scraper.short_name %}" method="post" class="staff">
        <input type="hidden" name="run_scraper" value="1" />
        <input type="submit" id="btnRunScraper" class="" value="Run this scraper" />
        <p>Runs this scraper as though from the schedule. (Staff only)</p>
    </form>

    <form action="{% url scraper_screenshoot_scraper scraper.wiki_type scraper.short_name %}" method="post" class="staff">
        <input type="hidden" name="screenshoot_scraper" value="1" />
        <input type="submit" id="btnScreenshootScraper" class="" value="Screenshoot this scraper" />
        <p>Take a screenshot of this scraper. (Staff only)</p>
    </form>
    {% endif %}

</div>
<br class="clear"/>
{% endblock %}

{% block run_script %}
    {{block.super}}

    {% if user.is_authenticated %}
        setupButtonConfirmation("btnClearDatastore", "Are you sure? Clicking 'ok' will delete all SCRAPED DATA and METADATA.");
        setupButtonConfirmation("btnDeleteScraper", "Are you sure? Clicking 'ok' will delete THE ENTIRE SCRAPER and it's data.");
    {% endif %}


    $("a#aShowTable").hide(); 
    $("a#aShowLess").hide(); 

    $("a#aHideTable").click(function() 
    {
        $("a#aHideTable").hide(); 
        $("a#aShowTable").show(); 
        $('table.data tbody tr').hide(); 
        $("a#aShowMore").css('color', '#aaa'); 
        $("a#aShowLess").css('color', '#aaa'); 
    }); 
    $("a#aShowTable").click(function() 
    {
        $("a#aShowTable").hide(); 
        $("a#aHideTable").show(); 
        $('table.data tbody tr.row').show(); 
        if ($("a#aShowLess").css('display') == 'inline')
            $('table.data tbody tr.morerow').show(); 
        $("a#aShowMore").css('color', 'rgb(38, 128, 198)'); 
        $("a#aShowLess").css('color', 'rgb(38, 128, 198)'); 
    }); 

    {% if data.morerows %}
      $("a#aShowMore").click(function() 
      {
          if ($("a#aHideTable").css('display') == 'inline')
          {
            $("a#aShowMore").hide(); 
            $("a#aShowLess").show(); 
            $('table.data tr.morerow').show(); 
          }
      }); 
      $("a#aShowLess").click(function() 
      {
          if ($("a#aHideTable").css('display') == 'inline')
          {
            $("a#aShowMore").show(); 
            $("a#aShowLess").hide(); 
            $('table.data tr.morerow').hide(); 
          }
      }); 
    {% else %}
      $("a#aShowMore").hide(); 
    {% endif %}

{% endblock %}
