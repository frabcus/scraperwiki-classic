{% extends "frontend/base.html" %}

{% load humanize %}
{% load schedule %}
{% load markup %}
{% load screen_shot %}

{% block title %}NEW &raquo; {% if scraper.owner.get_profile.name %}{{scraper.owner.get_profile.name}}{% else %}{{scraper.owner.username}}{% endif %} / {{ scraper.title }}{% endblock %}

{% block rss %}<link rel="alternate" type="application/rss+xml" title="RSS" href="/feeds/code_object_comments/{{ scraper.short_name }}" />{% endblock %}

{% block javascript %}
    <script type="text/javascript" src="{{ MEDIA_URL }}js/codeoverview.js?{{settings.REVISION}}"></script>

    {% if user.is_authenticated %}
        <script type='text/javascript'>
        $(document).ready(function() {
            setupCodeOverview('{{scraper.short_name}}');
        });
        </script>
    {% endif %}

{% endblock %}

{% block header %}
	<h2>
      <a href="{% if scraper.owner.username %}{% url profiles_profile_detail scraper.owner.username %}{% endif %}">{% if scraper.owner %}{% if scraper.owner.get_profile.name %}{{scraper.owner.get_profile.name}}{% else %}{{scraper.owner.username}}{% endif %}{% endif %}</a> / 
       {% if user.is_authenticated %}
         <span id="hCodeTitle" title="Click to edit&hellip;">{{ scraper.title }}</span> 
         <a id="aEditTitle" title="Edit title">Edit title</a>
       {% else %}
         {{ scraper.title }}
       {% endif %}
    </h2>
	<p>
	    <span class="language {{scraper.language|lower}}">
	        {% if scraper.language == 'php' %}PHP{% else %}{{ scraper.language|capfirst }}{% endif %}
	    </span>
	    <span class="latestdomain">
	    {% if latestdomain %}
	        {% for d in latestdomain %}
                <a href="{{ d.domain }}">{{ d.domain }}</a>
            {% endfor %}
        {% else %}
            Hasn&rsquo;t run yet
        {% endif %}
        </span> <span class="totalrows">
        {% if sqlitedata %}
            {{ total_record_count }} records
        {% else %}
            No data yet
        {% endif %}
        </span> <span class="privacystatus">
        {% if scraper.privacy_status == 'public' %}
    	    <abbr title="This {{scraper.wiki_type|lower}} can be viewed and edited by anyone">Public</abbr>
        {% endif %}
    	{% if scraper.privacy_status == 'visible' %}
    	    <abbr title="This {{scraper.wiki_type|lower}} can be viewed by anyone, but edited only by its owner and listed contributors">Protected</abbr>
        {% endif %}
        {% if scraper.vault %}
            <abbr title="This {{scraper.wiki_type|lower}} can only be viewed or edited by members of the vault &lsquo;{{ scraper.vault.name }}&rsquo;">In {% if scraper.vault.user.username == user.username %}your{% else %}{{scraper.vault.user.get_profile.name}}&rsquo;s{% endif %} vault</abbr>
        {% endif %}
        {% if scraper.privacy_status == 'private' %}
    	    <abbr title="This {{scraper.wiki_type|lower}} can only be viewed or edited by its owner or listed contributors">Private</abbr>
    	{% endif %}
        </span>  
    </p>
{% endblock %}


{% block content %}

<fieldset>
    <input type="hidden" id="hidScheduleOptions" value="{ {% for schedule_option, schedule_text in schedule_options %}'{{schedule_option|safe}}':'{{schedule_text|safe}}', {% endfor %} 'selected': 'PLACEHOLDER' }" />
    <input type="text" id="id_api_base" value="{{api_base}}" class="hide">
    {% if scraper.access_apikey %}
        <input type="text" id="id_apikey" value="{{scraper.access_apikey}}" class="hide">
    {% else %}
        <input type="text" id="id_apikey" value="" class="hide">
    {% endif %}
</fieldset>

<ul class="toolbar">
    <li class="edit"><a href="#">Edit</a></li>
    <li class="readonly"><a href="#">View <small>(read only)</small></a></li>
    <li class="copy"><a href="#">Copy</a></li>
    <li class="share">
        <a href="#">Share</a>
        <ul>
            <li class="facebook"><a href="#">Facebook</a></li>
            <li class="twitter"><a href="#">Twitter</a></li>
            <li class="buzzdata"><a href="#">BuzzData</a></li>
        </ul>
    </li>
    <li class="clear"></li>
</ul>

{% if scraper.is_sick_and_not_running %}
<div class="sick">
    <p>It looks like this scraper is broken!</p>
    {% if scraper.last_runevent.exception_message %}
    <p>On its last run it generated the following error: foo bar</p>
    {% else %}
    <p>We&rsquo;re not quite sure what&rsquo;s wrong with it. Could you <a href="#">take a look?</a></p>
    {% endif %}
</div>
{% endif %}

<div class="about">
    <div class="schedule">
        <h3><strong>Last run:</strong> 
            {% if scraper.last_runevent %}
              {% ifequal scraper.last_runevent.pid -1 %}
                  <a href="#run_{{ scraper.last_runevent.id }}" title="{{scraper.last_runevent.run_started}}">{{scraper.last_runevent.run_started|timesince}} ago</a>
              {% else %}
                <a href="#run_{{ scraper.last_runevent.id }}" title="{{scraper.last_runevent.run_started}}">right now</a>
              {% endifequal %}
            {% else %}
               Has not run yet
            {% endif %}
        </h3>
        {% if scraper.last_runevent %}
            <h4>Scraped: {{ scraper.last_runevent.pages_scraped }} page{{ scraper.last_runevent.pages_scraped|pluralize }} from {% for d in latestdomain %}<a href="{{ d.domain }}">{{ d.domain }}</a>{% endfor %}</h4>
        {% endif %}
        {% if scraper.last_runevent.exception_message %}
            <p class="exception">This scraper failed on its last run:<br/>{{ scraper.last_runevent.exception_message }}</p>
        {% endif %}
        <h3>Schedule</h3>
        {% ifnotequal scraper.scraper.next_run.year 9999 %}
        <h4>Runs: {{scraper.scraper.run_interval|schedule}}</h4>
        <h4>Will next run:
            {% ifequal scraper.scraper.next_run|timeuntil '0 minutes' %}
                <abbr title="This scraper will be run at the soonest possible opportunity">ASAP</abbr>
            {% else %}
                <abbr title="{{scraper.scraper.next_run}}">in {{scraper.scraper.next_run|timeuntil}}</abbr>
            {% endifequal %}
        {% else %}
        <h4>No schedule set: <a href="#">Run manually, now!</a></h4>
        {% endifnotequal %}</h4>
    </div>
    <div class="description">
        <h3><strong>About this scraper</strong></h3>
        <div id="divAboutScraper">
        {% if scraper.description %}
            {{ scraper.description_ashtml|safe }}
        {% else %}
            <p>This scraper has no description. {% if user.is_authenticated %}
                {% if user_edits_it %}
                    <a href="#" id="aEditAboutScraperNew">Would you like to add one?</a>
                {% endif %}
            {% else %}
                <a href="{% url login %}?next={% url code_overview 'scraper' scraper.short_name %}">Sign in to add one.</a>
            {% endif %}</p>
        {% endif %}
        </div>
        <div id="divContributors">
            {% if scraper.privacy_status == 'public' %}
        	    <abbr title="This {{scraper.wiki_type|lower}} can be viewed and edited by anyone">Public:</abbr>
            {% endif %}
        	{% if scraper.privacy_status == 'visible' %}
        	    <abbr title="This {{scraper.wiki_type|lower}} can be viewed by anyone, but edited only by its owner and listed contributors">Protected:</abbr>
            {% endif %}
            {% if scraper.vault %}
                <abbr title="This {{scraper.wiki_type|lower}} can only be viewed or edited by members of the vault &lsquo;{{ scraper.vault.name }}&rsquo;">In {% if scraper.vault.user.username == user.username %}your{% else %}{{scraper.vault.user.get_profile.name}}&rsquo;s{% endif %} vault:</abbr>
            {% endif %}
            {% if scraper.privacy_status == 'private' %}
        	    <abbr title="This {{scraper.wiki_type|lower}} can only be viewed or edited by its owner or listed contributors">Private:</abbr>
        	{% endif %}
        	{{ scraper.usercoderole_set.count }} {% if scraper.privacy_status == 'public' %}contributor{% else %}editor{% endif %}{{ scraper.usercoderole_set.count|pluralize }}
        </div>
    </div>
</div>

<div class="data">
    {% if sqlitedata %}
    <ul class="titlebar">
        <li><h3>This scraper&rsquo;s datatore</h3></li>
        <li><a class="api">Explore with API</a></li>
        <li>
            <a class="api">Download</a>
            <ul>
                <li><a href="#">This table as a CSV</a></li>
                <li><a href="#">All tables as CSVs</a></li>
                <li><a href="#">All tables as SQLite</a></li>
            </ul>
        </li>
        <li class="clear"></li>
    </ul>
    <table>
        <tr><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td></tr>    
    </table>
    {% else %}
    <ul class="titlebar">
        <li><h3>This scraper has no data yet</h3></li>
        <li><a href="">Import Data</a></li>
        <li class="clear"></li>
    </ul>
    {% endif %}
</div>

<div class="history">
    <ul class="titlebar">
        <li><h3>This scraper&rsquo;s history</h3></li>
        <li><a class="full_history">Show full history</a></li>
    </ul>
</div>

<div class="chat">
    <ul class="titlebar">
        <li><h3>This scraper&rsquo;s chat</h3></li>
    </ul>
</div>


{% endblock %}


{% block jrun_script %}
<script>
{{block.super}}
$(document).ready(function() 
{
    setupCodeOverview('{{scraper.short_name}}');
    setupScraperOverview('{{scraper.short_name}}');
    setupChangeEditorStatus();
    setupChangeAttachables('{{scraper.short_name}}'); 
{% if user.is_authenticated %}
//    setupButtonConfirmation("btnClearDatastore", "Are you sure? Clicking 'ok' will delete all SCRAPED DATA.");
//    setupButtonConfirmation("btnDeleteScraper", "Are you sure? Clicking 'ok' will delete THE ENTIRE SCRAPER and its data.");
{% endif %}
});
</script>
{% endblock jrun_script %}


