{% extends "editor_base.html" %}

{% block css %}
  <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}css/editor.css" />
  <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}css/main.css" />
{% endblock %}

{% block js %}
  <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery-1.3.2.js"></script>
  <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery.form.js"></script>

  <script type="text/javascript" src="{{ MEDIA_URL }}CodeMirror-0.63/js/codemirror.js"></script>
  <script type="text/javascript" src="{{ MEDIA_URL }}js/editor.js"></script>

<script type="text/javascript">
function addsbuttsavedefault(formData)
{
    var sbutt = null; 
    $.each(formData, function(i, obj) { if (obj.name == "sbutt")  sbutt = obj.value });
    if (!sbutt)
        formData[formData.length] = { "name": "sbutt", "value": "Save" }; 
    if (sbutt != "Reload")
        return true; 
    codeeditor.setCode($.ajax({url: $("#id_codeurl").val(), async: false}).responseText);
    return false; 
}

var codeeditor;
$(document).ready(function() 
{
    codeeditor = CodeMirror.fromTextArea("id_code", {
           parserfile: ["../contrib/python/js/parsepython.js"],
           stylesheet: "/media/CodeMirror-0.63/contrib/python/css/pythoncolors.css",
           path: "/media/CodeMirror-0.63/js/",
           textWrapping: false, 
           lineNumbers: true, 
           indentUnit: 4,
           readOnly: false,
           tabMode: "spaces", 
           autoMatchParens: true,
           width: '100%',
           parserConfig: {'pythonVersion': 2, 'strictErrors': true}, 
            });

    var runformoptions = 
    { 
        target:        '#outputarea', 
    }; 
//    $('#runform').ajaxForm(runformoptions);   // bind form using 'ajaxForm' 

    var ajaxformoptions = 
    { 
        target:        '#outputarea', 
        beforeSubmit:  function(formData) { return addsbuttsavedefault(formData); }, 
        success:       function() { codeeditor.focus(); }
    }; 
    $('#codewikiform').ajaxForm(ajaxformoptions);   // bind form using 'ajaxForm' 

})
</script>

{% endblock %}

{% block header %}
  {{ scraper.title }}
{% endblock %}

{% block content %}

<div class="editor">
    <div class="editor_header">
        <h1>{{ scraper.title }}</h1>
        <ul>
            <li><a href="#">Keyboard shortcuts</a></li>
            <li><a href="#">Editor settings</a></li>
            <li class="helplink"><a href="#">Code documentation</a></li>
        </ul>
    </div>

    <form id="codewikiform" method="POST" accept-charset="utf-8" action="{% url editor_savecommit short_name=short_name %}">
        <div class="editor_code">{{ form.code }}</div>
        <div id="resizebar" class="resizebar">&nbsp;</div>
        <div class="editor_controls">
            <input type="submit" name="action" value="Save" />            
            <input type="submit" name="action" value="Clear Console" id="clear" />   
            <input type="submit" name="action" value="SaveAndRun" />   
            <span id="fixedfields"> {{form.starttime}} {{form.short_name}}</span>
            <div class="right">
                <a href="{% url scraper_code scraper.short_name %}">Close and discard changes</a>
                <input type="submit" name="action" value="Commit and close" id="commit"/>            
            </div>
        </div>
    </form>

    <form id="runform" target="console" method="POST" accept-charset="utf-8" action="http://localhost:9004">
        <input type="submit" name="action" value="Run" id="run_script"/>
        <input type="text" id="id_code" name="code" value="import os; print dir(os)"/>
    </form>

    <textarea id="outputarea" cols="160" rows="5">
        output stuff here
    </textarea>

    <iframe name="console" id="console" style="width:100%"></iframe>

    <div class="editor_output">
        <div class="tabs">
            <ul>
                <li class="selected">
                    Console
                </li>
                <li>
                    Data
                </li>
                <li>
                    Sources
                </li>
            </ul>
        </div>
    </div>
</div>

{% endblock %}
{% block popups %}
    <div id="test" class="popup_item">
        Bla Bla
    </div>
{% endblock %}

