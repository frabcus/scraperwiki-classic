{% extends "editor_base.html" %}
{% block css %}
    <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}css/jquery-ui-1.7.2.custom.css" />
    <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}css/main.css" />
    <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}css/editor.css" />
{% endblock %}

{% block js %}
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery-1.3.2.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery-ui-1.7.2.custom.min.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery.form.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery.hotkeys-0.7.9.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery.htmlClean-min.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery.example.min.js"></script>

    <script type="text/javascript" src="{{ settings.CODEMIRROR_URL }}js/codemirror.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/editor.js?a=b"></script>  
{% endblock %}

{% block title %}
    {{ scraper.title }} | ScraperWiki
{% endblock %}

{% block content %}

    <fieldset>
        {# Hidden inputs for passing to js #}
        <input type="hidden" id="scraper_short_name" value="{{ scraper.short_name }}"/>
        <input type="hidden" id="scraper_guid" value="{{ scraper.guid }}"/>
        <input type="hidden" id="code_runningMode" value="{{ settings.CODE_RUNNING_MODE|escape }}"/>    
        <input type="hidden" id="codemirror_url" value="{{ settings.CODEMIRROR_URL }}"/>
    </fieldset>
    <form method="POST" accept-charset="utf-8" id="editor" action="">
        <div class="editor">
            {% if has_draft %}
            <div class="draft_warning">
                Warning: this scraper has not been saved or committed. Click the save button or <a href="{% url delete_draft scraper.short_name|default:"__new__" %}">discard changes</a>.
            </div>
            {% endif %}

            {# Header #}
            <div class="editor_header">
                <div class="title">
                    {{ form.title }}
                </div>
                <div id="meta_fields_mini">
                    {# for form elements that are shown in the popup #}

                    <div class="field field-title">
                        <label for="id_meta_title">{{ form.title.label}}</label>
                        <input type="text" name="title" value="" id="id_meta_title">
                    </div>

                    <div class="field field-description">
                        <label for="id_description">{{ form.description.label}} {{ form.license.errors }}</label>
                        {{ form.description }}
                    </div>
            
                    <div class="field field-license">
                        <label for="id_license">{{ form.license.label }} {{ form.license.errors }}</label>
                        {{ form.license }}
                    </div>
            
                    <div class="field field-source">
                        <label for="id_source">{{ form.source.label}} {{ form.source.errors }}</label>
                        {{ form.source }}
                    </div>

                    <div class="field field-tags">
                        <label for="id_tags">{{ form.tags.label}} {{ form.tags.errors }}</label>
                        {{ form.tags }}
                    </div>

                    <div class="field field-commit_message">
                      <label for="id_commit_message">{{ form.commit_message.label}} {{ form.commit_message.errors }}</label>
                      {{ form.commit_message }}
                    </div>

                </div>

                <ul class="help">
                    <li>
                        <a id="menu_shortcuts" href="#" title="Key combinations for saving, executing etc">Keyboard shortcuts</a>
                    </li>
                    <!--
                    <li>
                        <a id="menu_settings" href="#">Editor settings</a>
                    </li>
                    -->
                    <li class="helplink">
                        <a id="menu_documentation" href="#" title="Quick help">Code documentation</a>
                    </li>
                </ul>          
            </div>

            {# Code editor #}
            <div class="editor_code" id="codeeditordiv">
                {{ form.code }}
            </div>

            {# Controls #}
            <div class="editor_controls">
                <input type="submit" class="save  button" name="action" value="Save draft" title="Save draft version" />            
                <input type="button" value="Diff" name="diff" id="diff" title="View diff with the committed version"/>
                <input type="button" value="Reload" name="reload" id="reload" title="Reload the latest saved version"/>
                <input type="button" class="execute" value="Run" name="run" id="run" title="Run this scraper"/>
                <img id="running_annimation" src="{{ MEDIA_URL }}/images/running.gif"/>
                <div class="right">
                    {% if scraper.short_name %}
                        <a href="{% url scraper_code scraper.short_name %}" title="Return to scraper page">Close editor</a>
                    {% else %}
                        <a href="{% url frontpage %}" title="Close editor">Close editor</a>                
                    {% endif %}
                    <input type="submit" class="commit button" name="action" value="Commit and publish" title="Commit this scraper and publish on the site"/>            
                </div>
            </div>

            {# Consoles #}
            <div class="editor_output" id="outputeditordiv">
                <div class="tabs">
                    <ul>
                        <li class="console">
                            <a href="#" title="Console output from scraper">Console</a>
                        </li>
                        <li class="data">
                            <a href="#" title="The data that this scraper generates">Data</a>                            
                        </li>
                        <li class="sources">
                            <a href="#" title="Pages you are scraping">Sources</a>                            
                        </li>
                    </ul>
                </div>
                <div class="info">
                    <div id="output_console" class="output">
                        <div class="output_content"></div>
                    </div>
                    <div id="output_data" class="output">
                        <table class="output_content">

                        </table>
                    </div>
                    <div id="output_sources" class="output">
                        <div class="output_content"></div>
                    </div>
                </div>
                <div class="controls">
                     <div id="controls_console">
                         <a id="clear"  href="#" title="clear the console tab">Clear console</a>
                     </div>
                 </div>
                <iframe name="console" id="console" style="display:none;"><pre></pre></iframe>
            </div>
      </div>
      
      <div id="feedback_messages">
          
      </div>

{% endblock %}

{% block popups %}    
    <div id="meta_form" class="popup_item"><a class="popupClose">x</a></div>
    <div id="diff" class="popup_item"><a class="popupClose">x</a><pre></pre></div>
    <div id="popup_shortcuts" class="popup_item">
        <a class="popupClose">x</a><pre></pre>
        <h3>Keyboard shortcuts</h3>
        <ul>
            <li>Control-S   Save</li>
            <li>Control-E   Run</li>
            <li>Control-R   Reload</li>
            <li>Control-D   Diff</li>
        </ul>
    </div>
    <div id="popup_settings" class="popup_item">
        <a class="popupClose">x</a>
        <h3>Editor settings</h3>
    </div>    
    <div id="popup_documentation" class="popup_item">
        <a class="popupClose">x</a>
        <dl class="quick_help">
            <h4>Recommended libraries</h4>
            <ul>
                <li><code><b>BeautifulSoup</b></code>
                    For parsing html.  <a href="/editor/beautifulsoup_demo" target="_blank">demo</a>  <a href="http://www.crummy.com/software/BeautifulSoup/" target="_new">docs</a>
                </li>
                <li><code><b>mechanize</b></code>
                    For navigating form fillings.  <a href="/editor/mechanize_demo" target="_blank">demo</a>  <a href="http://wwwsearch.sourceforge.net/mechanize/" target="_new">docs</a>
                </li>
                <li><code><b>lxml</b></code>
                    For parsing html and accessing it using cssselect.  <a href="/editor/lxml_demo" target="_blank">demo</a>  docs
                </li>
                <li><code><b>urllib2</b></code>
                    Standard python library for opening urls.  <a href="/editor/urllib2_demo" target="_blank">demo</a>  <a href="http://docs.python.org/library/urllib2.html" target="_blank">docs</a>
                </li>
            </ul>

            <h4><code>scraperwiki</code> (utils)</h4>
            <ul>
                <li><code><b>scrape</b>(url, params={ })</code>
                    Returns the body text from a url
                </li>
                <li><code><b>parse_html</b>(text)</code>
                    Converts an HTML string to an <a href="http://codespeak.net/lxml/" target="_new">lxml.etree</a> object
                </li>
                <li><code><b>pdftoxml</b>(pdfdata)</code>
                    Converts the binary data of a PDF file into a parsable XML string
                </li>
            </ul>

            <h4><code>scraperwiki.datastore</code> <a href="/editor/datastore_demo" target="_blank">demo</a></h4>
            <ul>
                <li><code><b>save</b>(unique_keys=[], data={})</code>
                    Saves the dict data to the datastore, over-writing all records that have the same values for the keys in the list unique_keys.
                (Optional special keys are date (should be a date object), and latlng> (should be a pair of floats (latitude, longitude).))
                </li>
                <li><code><b>loadallofcurrentscraper</b>(filterdata={})</code>
                    Returns list of dicts (records) that match the key-values given by filterdata.
                </li>
                <li><code><b>deleteallofcurrentscraper</b>(filterdata={})</code>
                    Deletes all records that match the key-values of filterdata.
                </li>
            </ul>                

            <h4><code>scraperwiki.page_cache</code> <a href="/editor/page_cache_demo" target="_blank">demo</a></h4>
            <ul>
                <li><code><b>savepage</b>(tag, name, text)</code>  
                    Backs up text of a scraped page under a particular name.
                </li>
                <li><code><b>getpagebyname</b>(name)</code>  
                    Returns text of page that was saved earlier.
                </li>
                <li><code><b>getnamesfromtag</b>(tag)</code>  
                    List of page names for a given tag.
                </li>
            </ul>
        </dl>
    </div>
    <div id="popup_text" class="popup_item">
        <a class="popupClose">x</a>
        <div class="tabs">
          <ul>
            <li class="raw_tab"><a href="#">RAW</a></li>
            <li class="html_tab"><a href="#">HTML</a></li>
          </ul>
        </div>
        <div class="popup_html output"><iframe></iframe></div>
        <div class="popup_raw output" style="display:none"><pre></pre></div>
    </div>            
</form>
{% endblock %}
